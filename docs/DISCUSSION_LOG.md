# 設計議論ログ

## 議論の経緯と意思決定記録

### 1. 初期要件（ユーザーからの要望）

**要望:**
- 町内会でメッセージ配布プラットフォームを作りたい
- LINEのようなSMSで一括配布できるWebアプリ
- ユーザーID/パスワード登録ではなく（オプション）
- スマホの個体番号で既読未読がわかるようにしたい

**解釈:**
- 高齢者が多い町内会で、パスワード管理は現実的でない
- 「個体番号」= デバイス固有のIDで自動認識したい
- 回覧板のデジタル代替として、配信→既読追跡がコア機能

---

### 2. プロトタイプv1 の設計判断

**採用したアプローチ:**
- ブラウザ生成UUID で端末を識別
- 名前だけ登録すれば参加可能（ログイン不要）
- 管理者はPINコードでログイン

**v1で実装した機能:**
- メッセージ一覧（未読は青背景＋ドット表示）
- タップで展開→自動既読マーク
- カテゴリフィルタ（防災・行事・ゴミなど）
- 管理者: メッセージ作成（重要度4段階 × カテゴリ6種）
- 管理者: 配信状況ダッシュボード（既読率プログレスバー）
- 管理者: 登録端末一覧
- 5秒ごとの新着ポーリング

**v1の課題:**
- ブラウザデータ消去で別人扱いになる
- 「誰が未読か」が名前との紐付けが弱い

---

### 3. 個体認証方式の検討

**比較検討した4方式:**

| 方式 | 評価 |
|------|------|
| UUID | △ 簡単だがデータ消去で消える |
| FingerprintJS | ○ 高精度だがOS更新で変動 |
| WebAuthn/FIDO2 | ◎ 暗号的に確実、パスワード不要 |
| SMS認証 | ◎ 確実だが高齢者に負担大 |

**推奨した構成:**
ハイブリッド方式
- 第1層: UUID（全員カバー）
- 第2層: FingerprintJS（UUID消去時の復旧用）
- 第3層: WebAuthn（役員向けオプション）

---

### 4. 電話番号の採用

**ユーザーの提案:** 電話番号で登録してもよいか？

**分析結果（電話番号がフィットする理由）:**
- 町内会の名簿にそもそも電話番号が記載済み → 心理的抵抗が低い
- 端末買い替えても同じ番号で継続可能
- 高齢者にわかりやすい
- 名簿との突合で「誰が未読か」が明確

**コスト検討（SMS認証を使う場合）:**
- Twilio: 約 ¥10/通
- 初回だけSMS認証 → 以降トークン自動認識が現実的

**代替案として検討:**
- 案A: 電話番号＋PIN配布（SMS不要、回覧板で配布）
- 案B: 電話番号のみ（認証なし、なりすましリスク低い）
- 案C: 初回SMS + トークン

**案Aが町内会にはベストバランスと判断。**
ただし最終的にはユーザーの次の要望で方向転換。

---

### 5. 最終決定: 電話番号 + デバイス生体認証

**ユーザーの最終要望:**
「電話番号とデバイス側の認証（Face IDとか）」

**これが最もモダンかつ実用的な構成:**
- 電話番号 = 「誰か」の識別子
- Face ID/指紋 = 「本人か」の確認
- パスワード完全不要
- 高齢者も「指紋を当てるだけ」で理解可能

**プロトタイプv2で実装:**
- 3ステップ登録UI（電話番号 → 名前 → 生体認証）
- 再訪問時の「おかえりなさい」画面
- 実際のWebAuthn API呼び出し（対応端末）
- 非対応環境でのデモモードフォールバック
- 管理者画面に電話番号・認証方式・既読者/未読者名表示

---

## 未解決の検討事項

1. **管理者認証の強化** - 現在は固定PIN。WebAuthn + ロール管理に移行すべき
2. **複数町内会対応** - マルチテナント構成にするか
3. **データ保持期間** - 古いメッセージの自動アーカイブ/削除ポリシー
4. **プライバシーポリシー** - 電話番号の取り扱い、個人情報保護法対応
5. **ホスティング** - セルフホスト vs クラウド（顧客のコントロール重視の方針と合致するか）
6. **オフライン対応** - Service Worker によるキャッシュ戦略
7. **アクセシビリティ** - 高齢者向けフォントサイズ調整、コントラスト
